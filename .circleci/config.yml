version: 2.1

.service_name: &service_name github-discussions-crawler

.default_image: &default_image
  docker:
  - image: circleci/openjdk:8-jdk
  working_directory: ~/project

.defaults: &defaults
  environment:
    MAINTAINER: "info@qualiton.org"
    SERVICE_NAME: *service_name
    HELM_VERSION: "v2.10.0"

.attach_workspace: &attach_workspace
  attach_workspace:
    at: ~/

.persist_to_workspace: &persist_to_workspace
  persist_to_workspace:
    root: ~/
    paths:
    - project/*
    - chart/*

.cache_key: &cache_key
              v1-repo-{{ .Environment.CIRCLE_PROJECT_REPONAME }}-{{ .Branch }}-{{ checksum "project/Dependencies.scala"}}

.restore_cache: &restore_cache
  restore_cache:
    name: Restoring project cache
    keys:
    - *cache_key

.setup_git: &setup_git
  run:
    name: Setup git
    command: |
      sh ~/scripts/init_github.sh

jobs:
  compile:
    <<: *default_image
    steps:
    - checkout
    - *restore_cache
    - run:
        name: Compile project
        command: sbt ";clean ;compile ;test:compile ;it:compile ;e2e:compile"
    - save_cache:
        name: Saving project cache
        key: *cache_key
        paths:
        - ~/.m2
        - ~/.ivy2
        - ~/.sbt
        - target/resolution-cache
        - project/target/resolution-cache
    - *persist_to_workspace

  test:
    <<: *default_image
    steps:
    - *attach_workspace
    - *restore_cache
    - run:
        name: Run tests
        command: sbt test

  ittest:
    <<: *default_image
    steps:
    - *attach_workspace
    - *restore_cache
    - run:
        name: Run integration tests
        command: sbt it:test

  e2etest:
    <<: *default_image
    steps:
    - *attach_workspace
    - *restore_cache
    - run:
        name: Run e2e tests
        command: sbt e2e:test

  build:
    <<: *default_image
    <<: *defaults
    steps:
    - *attach_workspace
    - *restore_cache
    - setup_remote_docker
    - *setup_git
    - run:
        name: Sbt release
        command: |
          sbt "release with-defaults"
    - run:
        name: Docker Login
        command: |
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - run:
        name: Push container to registry
        command: |
          docker push "$DOCKER_USERNAME/$SERVICE_NAME"
    - *persist_to_workspace

  release_chart:
    <<: *default_image
    <<: *defaults
    steps:
    - *attach_workspace
    - *restore_cache
    - *setup_git
    - run:
        name: Init helm
        command: |
          curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash -s -- -v $HELM_VERSION
          helm init --client-only
    - run:
        name: Package chart
        command: |
          cd ~/project/.helm
          helm package $SERVICE_NAME
          mv $SERVICE_NAME-*.tgz /tmp
    - run:
        name: Release chart
        command: |
          cd ~/project/
          git checkout gh-pages
          git clean -f -d
          mv /tmp/$SERVICE_NAME-*.tgz .
          helm repo index . --url https://qualiton.github.io/github-discussions-crawler/
          VERSION=`ls $SERVICE_NAME-*.tgz | awk -F"$SERVICE_NAME-" '{print $2}' | awk -F".tgz" '{print $1}'`
          git add .
          git commit -a -m "add version $VERSION"
          git push origin gh-pages

workflows:
  version: 2
  build-and-deploy:
    jobs:
    - compile
    - test:
        requires:
        - compile
    - ittest:
        requires:
        - compile
    - e2etest:
        requires:
        - compile
    - build:
        filters:
          branches:
            only: master
        requires:
        - test
        - ittest
        - e2etest
    - release_chart:
        requires:
        - build
